<template>
    <section class="xl:w-auto mx-10 sm:mx-20 xl:ml-0 h-full sm:mt-0 mb-32 sm:mb-0">

        <span class="flex items-center gap-6 mb-2">
            <h2 class="font-semibold my-0 text-[27px]">Next Steps</h2>
            <img src="../../assets/edit-icon.png" alt="Edit icon" class="w-7">
        </span>

        <div>
            <h3 class="text-sm font-medium">Follow these Steps:</h3>

            <span class="flex gap-5 flex-wrap">
                <button @click="saveReimbursement"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">Save
                    for
                    later</button>
                <button @click="emailPDF"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">Email
                    Reimbursement Claim</button>
                <button @click="createPdf"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">
                    Preview
                    Reimbursement Request</button>
                <button @click="download"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">
                    Download PDF</button>
                <button @click="submitTicket"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">Submit
                    Reimbursement Request</button>

            </span>
            <br>
            <span class="flex gap-5 flex-wrap">
                <button @click="saveAsTemplate"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">Save
                    as
                    Template</button>
                <button @click="discardChanges"
                    class="bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs ">Discard
                    Changes</button>
            </span>
            <h5 class="font-normal" v-if="currentlyCreatingPDF">Generating PDF, please wait...</h5>
        </div>
        <confirmation-popup v-if="showConfirmationPopup" left-button-text="Discard Changes" right-button-text="Cancel"
            :cancel-function="returnToDashboard" :continue-function="cancelConfirmationPopup">
            <template #message>
                Are you sure you want to discard the changes you made to this reimbursement claim?
            </template>
        </confirmation-popup>
        <div v-if="showEmailPopup"
            class="absolute bg-black bg-opacity-50 h-screen top-0 left-0 w-screen items-center flex justify-center">
            <div
                class="bg-white shadow-md border border-solid border-gray-100 h-min px-6 box-border w-96 py-3 rounded-md">
                <span class="flex items-center m-0">
                    <h3 class="font-semibold mb-0">Send this claim attached to an email</h3>
                    <img :src="CancelIcon" alt="Cancel icon" class="w-3 cursor-pointer" @click="showEmailPopup = false">
                </span>
                <span>
                    <Form @submit="sendEmail">
                        <div>
                            <h4 class="font-semibold text-sm">Recipient</h4>
                            <Field class="h-8 w-full box-border px-3 border-gray-300 border-solid border rounded-md"
                                :rules="isValidRecipientEmail" name="recipient" type="text">
                            </Field>
                            <ErrorMessage name="recipient" class=" text-red-400 text-xs mt-2" />
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm">Subject</h4>
                            <Field class="h-8 w-full box-border px-3 border-gray-300 border-solid border rounded-md"
                                name="subject" type="text">
                            </Field>
                            <ErrorMessage name="subject" class=" text-red-400 text-xs mt-2" />
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm leading-7">Message (Any supplementary info will be
                                included
                                in your
                                email)
                            </h4>
                            <Field name="message" type="text"
                                class="h-20 resize-none w-full box-border px-3 py-3 text-sm border-gray-300 border-solid border rounded-md"
                                as="textarea">
                            </Field>
                            <ErrorMessage name="message" class="text-red-400" />
                        </div>
                        <button type="submit"
                            class="mt-6 mb-2 bg-udmercy-blue text-white border-none w-auto px-5 h-11 rounded-full cursor-pointer text-xs">Send
                            email</button>
                        <h3 class="text-sm font-medium leading-6">Note: Your reimbursement claim PDF will be
                            attached to
                            this
                            email</h3>
                    </Form>
                </span>
            </div>
        </div>
    </section>
</template>

<script lang="ts" setup>
import axios from 'axios';
import parseDate from '../../utils/parseDate';
import { Form, Field, ErrorMessage, validate } from 'vee-validate';
import { ReimbursementTicket } from '../../types/types';
import { onMounted, ref } from 'vue';
import ConfirmationPopup from '../utilities/ConfirmationPopup.vue';
import { useRoute, useRouter } from 'vue-router';
import { TYPE, useToast } from 'vue-toastification';
import pdfMake from "pdfmake/build/pdfmake";
import { isValidRecipientEmail } from '../../utils/validators';
import CancelIcon from "../../assets/cross-icon.svg"

const toast = useToast()

const props = defineProps<{
    claim: ReimbursementTicket
}>()
const route = useRoute()
const router = useRouter();
const emits = defineEmits(["onClaimSaved"])

let currentlyCreatingPDF = ref<boolean>(false);
let userIsEditingReimbursement = ref<boolean>(false);
let showConfirmationPopup = ref<boolean>(false)
let showEmailPopup = ref<boolean>(false)

function returnToDashboard() {
    router.push("/dashboard")
}

function cancelConfirmationPopup() {
    showConfirmationPopup.value = false
}

function emailPDF() {
    showEmailPopup.value = true
}

async function sendEmail(values: any, { resetForm }) {
    try {
        let response = await axios
            .get(
                `${import.meta.env.VITE_API_URL}/api/retrieveAccountInformation`
            )


        await axios.post(`${import.meta.env.VITE_API_URL}/api/send-reimbursement-email`, {
            message: values.message,
            subject: values.subject,
            recipient: values.recipient,
            reimbursementData: props.claim,
            userInfo: response.data,
        })

        toast("Your email was sent successfully", {
            type: TYPE.SUCCESS
        })

        resetForm()
        showEmailPopup.value = false
        //clear email values etc
    } catch (err) {
        console.log(err)
    }
}

function downloadPDF(pdfData: string) {
    const linkSource = pdfData;
    let iframe =
        "<iframe width='100%' height='100%' src='" + linkSource + "'></iframe>";
    let x = window.open();
    if (x != null) {
        x.document.open();
        x.document.write(iframe);
        x.document.close();

        // Remove padding from the iframe content
        x.document.querySelector("style") ||
            x.document.head.appendChild(x.document.createElement("style"));
        // @ts-ignore
        x.document.querySelector("style").textContent += `
  body, iframe {
    margin: 0;
    padding: 0;
    overflow: hidden
  }
`;
    }
}

async function download() {
    toast("Creating your reimbursement claim PDF. Please wait...", {
        type: TYPE.INFO
    })

    axios
        .get(
            `${import.meta.env.VITE_API_URL}/api/retrieveAccountInformation`
        )
        .then((response) => {
            props.claim.totalCost = getAllActivitiesAmount();

            const totalCoveredFoapaCost = props.claim.foapaDetails.reduce((acc, curr,) =>
                acc += Number(curr.cost)
                , 0)


            if (totalCoveredFoapaCost > props.claim.totalCost) {
                toast("Warning: The amount of money you are retrieving from your FOAPAs is more than the amount of money you are trying to get reimbursed for. Please double check your FOAPA coverages and make sure they match.", {
                    type: TYPE.WARNING,
                    timeout: false
                })

            } else if (totalCoveredFoapaCost < props.claim.totalCost) {
                toast("Warning: The amount of money you are retrieving from your FOAPAs is less than the amount of money you are trying to get reimbursed for. Please double check your FOAPA coverages and make sure they match.", {
                    type: TYPE.WARNING,
                    timeout: false
                })
            }

            axios
                .get(`${import.meta.env.VITE_API_URL}/api/generatePdf`, {
                    params: {
                        reimbursementData: props.claim,
                        userInfo: response.data,
                    },
                })
                .then((res) => {
                    const link = document.createElement('a');
                    const fileName = "reimbursement_claim.pdf";

                    link.href = res.data;
                    link.download = fileName;
                    link.click();
                })
                .catch((err) => {
                    console.log("error: " + err);
                    toast("There was an error generating your PDF. Please try again later", {
                        type: TYPE.ERROR
                    })
                });
        }).catch((err) => {
            toast("There was an error generating your PDF. Please try again later", {
                type: TYPE.ERROR
            })
        });
}


async function saveAsTemplate() {
    try {
        toast("Saving reimbursement claim as template...", {
            type: TYPE.INFO
        })
        await axios.post(`${import.meta.env.VITE_API_URL}/api/saveAsTemplate`, props.claim)
        toast("Reimbursement saved as a template successfully.", {
            type: TYPE.SUCCESS
        })
    } catch (error) {
        toast("An unexpected error occured when saving your claim as a template. Please try again later", {
            type: TYPE.ERROR
        })
    }
}

async function submitTicket() {
    try {
        if (props.claim.foapaDetails.length === 0) {
            toast("Warning: You are submitting this claim without adding any FOAPA numbers to cover the cost", {
                type: TYPE.WARNING,
                timeout: false
            })
        }
        if (props.claim.reimbursementReceipts.length === 0) {
            toast("Error: Before submission, you must have at least proof of payment/receipt attached with this reimbursement claim.", {
                type: TYPE.ERROR,
                timeout: false
            })
            return
        }


        props.claim.reimbursementStatus = "Submitted";

        await axios.post(
            `${import.meta.env.VITE_API_URL}/api/updateReimbursement`,
            {
                reimbursementTicket: props.claim,
            }
        );

        // router.push("/dashboard");
        toast("Reimbursement claim submitted successfully", {
            type: TYPE.SUCCESS
        });
    } catch (error) {
        toast("An error occured while submitting your reimbursement claim. Please try again later", {
            type: TYPE.INFO
        })
    }
}


function getAllActivitiesAmount(): number {
    let sum: number = 0;
    props.claim.activities.forEach((activity) => {
        sum += Number(activity.cost);
    });
    return sum;
}

function createPdf() {
    toast("Creating your reimbursement claim PDF. Please wait...", {
        type: TYPE.INFO
    })

    axios
        .get(
            `${import.meta.env.VITE_API_URL}/api/retrieveAccountInformation`
        )
        .then((response) => {
            props.claim.totalCost = getAllActivitiesAmount();

            const totalCoveredFoapaCost = props.claim.foapaDetails.reduce((acc, curr,) =>
                acc += Number(curr.cost)
                , 0)


            if (totalCoveredFoapaCost > props.claim.totalCost) {
                toast("Warning: The amount of money you are retrieving from your FOAPAs is more than the amount of money you are trying to get reimbursed for. Please double check your FOAPA coverages and make sure they match.", {
                    type: TYPE.WARNING,
                    timeout: false
                })

            } else if (totalCoveredFoapaCost < props.claim.totalCost) {
                toast("Warning: The amount of money you are retrieving from your FOAPAs is less than the amount of money you are trying to get reimbursed for. Please double check your FOAPA coverages and make sure they match.", {
                    type: TYPE.WARNING,
                    timeout: false
                })
            }

            axios
                .get(`${import.meta.env.VITE_API_URL}/api/generatePdf`, {
                    params: {
                        reimbursementData: props.claim,
                        userInfo: response.data,
                    },
                })
                .then((res) => {
                    console.log(res.data)
                    downloadPDF(res.data);
                    currentlyCreatingPDF.value = false;
                })
                .catch((err) => {
                    toast("There was an error generating your PDF. Please try again later", {
                        type: TYPE.ERROR
                    })
                });
        }).catch((err) => {
            toast("There was an error generating your PDF. Please try again later", {
                type: TYPE.ERROR
            })
        });
}


async function updateReimbursement() {
    props.claim.totalCost = getAllActivitiesAmount();
    props.claim.reimbursementDate = parseDate(
        new Date().toISOString()
    );

    await axios.post(
        `${import.meta.env.VITE_API_URL}/api/updateReimbursement`,
        {
            reimbursementTicket: props.claim,
        }
    );

    toast("Reimbursement claim updated successfully.", {
        type: TYPE.SUCCESS
    })
    router.push("/dashboard")
}

async function addReimbursement() {
    try {
        props.claim.totalCost = getAllActivitiesAmount();
        props.claim.reimbursementDate = parseDate(
            new Date().toISOString()
        );

        await axios.post(
            `${import.meta.env.VITE_API_URL}/api/addReimbursement`,
            {
                reimbursementTicket: props.claim,
            }
        );

        toast("Reimbursement claim saved successfully.", {
            type: TYPE.SUCCESS
        })
        router.push("/dashboard")
    } catch (error) {
        toast("There was an error saving this reimbursement claim. Please try again later", {
            type: TYPE.ERROR
        })
    }
}

async function saveReimbursement() {
    try {
        if (props.claim.reimbursementName.trim() === "") {
            toast("Please add a title to this reimbursement claim", {
                type: TYPE.ERROR
            });

            return;
        }

        toast("Saving reimbursement claim...", {
            type: TYPE.INFO
        })

        props.claim.reimbursementStatus = "In Progress";

        emits("onClaimSaved")

        if (userIsEditingReimbursement.value) {
            await updateReimbursement();
        } else {
            await addReimbursement();
        }


    } catch (err) {
        toast("There was an error saving this reimbursement claim. Please try again", {
            type: TYPE.ERROR
        })
    }
}

function discardChanges() {
    showConfirmationPopup.value = true
    emits("onClaimSaved")

}

onMounted(() => {
    if (route.query.reimbursementId) {
        userIsEditingReimbursement.value = true;
    }
})

</script>